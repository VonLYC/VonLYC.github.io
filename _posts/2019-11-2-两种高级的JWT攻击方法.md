---

layout:     post                    # 使用的布局（不需要改）
title:      两种高级的JWT攻击方法               # 标题 
subtitle:    #副标题
date:       2019-11-1              # 时间
author:     Von                      # 作者
header-img: img/post-bg-hacker.jpg    #这篇文章标题背景图片
catalog: true                       # 是否归档
tags:                               #标签
    - Web

---

# 写在前面
从前一篇文章中，我们了解了JWT认证和一种绕过方法，但是之后我发现关于绕过JWT还存在两种比较高级的绕过方法，在这篇文章里面我将介绍这两种方法。  

# 密钥可控攻击
这里以2018年国赛的一道题目作为讲解。在题目中，我们遇到了这样的JWT:
```
eyJ0eXAiOiJKV1QiLCJhbGciOiJzaGEyNTYiLCJraWQiOiI4MjAxIn0.eyJuYW1lIjoiYWRtaW4yMzMzIn0.aC0DlfB3pbeIqAQ18PaaTOPA5PSipJe651w7E0BZZRI
```
其header和payload如下所示:
![](/img/JWT2-1.jpg)
这里的kid是key的id，在数据库中查询key的逻辑类似于:  
``` sql
select * from table where kid = $kid
```
查询出来的结果即为key的值。那么我们就可以构造类似于sql注入的语句，执行联合查询
``` sql
kid = 0 union select 1
```
这样我们就可以使得查询出来的key结果一定为1，也就达到了控制密钥的目的。
接下来我们就可以根据密钥生成相应的JWT以达到伪造登录的目的了。
![](/img/JWT2-2.png)

# 算法修改攻击

## 将非对称加密算法改为对称加密算法
算法HS256使用秘密密钥对每条消息进行签名和验证。  
算法RS256使用私钥对消息进行签名，并使用公钥进行验证。  
如果将算法从RS256更改为HS256，后端代码会使用公钥作为秘密密钥，然后使用HS256算法验证签名。  
如果我们可以获取到公钥，那么我们就可以通过将算法从RS256修改为HS256，然后使用RSA公钥对数据进行签名，后端代码会使用RSA公钥+HS256算法进行签名验证。从而达到了绕过的效果。  

## 具体例子
可以看这个网站的例子:[http://demo.sjoerdlangkemper.nl/jwtdemo/hs256.php](http://demo.sjoerdlangkemper.nl/jwtdemo/hs256.php)  
[公钥文件](http://demo.sjoerdlangkemper.nl/jwtdemo/public.pem)
解题代码如下:
``` python
import jwt
public = open('public.pem', 'r').read()
print jwt.encode({"user": "admin"}, key=public, algorithm='HS256')
```
即可以成功绕过。  
![](/img/JWT2-3.png)


## 修改算法为NONE
签名算法保证了JWT在传输的过程中不被恶意用户修改,但是header中的alg字段可被修改为none。  
一些JWT库支持none算法，即没有签名算法，当alg为none时后端不会进行签名校验，将alg修改为none后，去掉JWT中的signature数据（仅剩header + '.' + payload + '.'）然后提交到服务端即可。  
当然，这种只适用于低版本的JWT库，高版本的JWT库一般都不支持这种算法。故在此不给出例子。


# 参考文章
[一叶飘零师傅的文章](https://skysec.top/2018/05/19/Json-Web-Token%E5%8E%86%E9%99%A9%E8%AE%B0/#%E5%AF%86%E9%92%A5%E5%8F%AF%E6%8E%A7%E9%97%AE%E9%A2%98)  
[Chybeta师傅的文章](https://chybeta.github.io/2017/08/29/HITB-CTF-2017-Pasty-writeup/)  
[dlive师傅的文章](https://www.cnblogs.com/dliv3/p/7450057.html)  
[简书上的文章](https://www.jianshu.com/p/e64d96b4a54d)  

